<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—è</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    /* ... (–í—Å–µ –≤–∞—à–∏ CSS —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ... */
    :root {
      --bg-color: var(--tg-theme-bg-color, #ffffff);
      --text-color: var(--tg-theme-text-color, #000000);
      --button-color: var(--tg-theme-button-color, #007bff);
      --button-text-color: var(--tg-theme-button-text-color, #ffffff);
      --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --hint-color: var(--tg-theme-hint-color, #999999);
      --separator-color: var(--tg-theme-separator-color, #e0e0e0);
      --danger-color: #ff453a; /* –ù–û–í–´–ô –°–¢–ò–õ–¨ */
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
      padding-bottom: calc(32px + env(safe-area-inset-bottom)); 
    }
    h2, h3 { color: var(--text-color); margin-top: 0; }
    h2 { margin-bottom: 8px; }
    #driverNameDisplay {
      color: var(--hint-color);
      font-weight: 500;
      font-size: 1.1em;
      margin-top: -5px;
      margin-bottom: 20px;
    }
    label { display: block; margin-top: 16px; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; }
    input, select, textarea {
      width: 100%; padding: 14px 12px; margin-top: 4px; border-radius: 8px;
      border: 1px solid var(--separator-color);
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      box-sizing: border-box; font-size: 1em;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: border-color 0.2s ease;
      -webkit-appearance: none;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--button-color); }
    input::placeholder, textarea::placeholder { color: var(--hint-color); }
    select {
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23${(p=>p.substring(1))(getComputedStyle(document.documentElement).getPropertyValue('--hint-color').trim() || '#999999')}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 1.2em;
      padding-right: 36px;
    }
    button {
      width: 100%; padding: 14px 12px; margin-top: 8px; border-radius: 10px;
      border: none; font-size: 1em; font-weight: 600; cursor: pointer;
      transition: opacity 0.15s ease;
    }
    button:active { opacity: 0.85; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    button[type="submit"] {
      background-color: var(--button-color);
      color: var(--button-text-color);
      margin-top: 24px;
    }
    button.toggle-btn {
      background-color: var(--secondary-bg-color);
      color: var(--button-color);
      margin-top: 15px;
      font-weight: 500;
    }
    /* –ù–û–í–´–ô –°–¢–ò–õ–¨ */
    button.toggle-btn-danger {
      background-color: var(--secondary-bg-color);
      color: var(--danger-color);
      margin-top: 10px;
      font-weight: 500;
      border: 1px solid var(--danger-color);
    }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    hr { border: 0; border-top: 1px solid var(--separator-color); margin: 24px 0; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); display: none; align-items: center;
      justify-content: center; padding: 16px; box-sizing: border-box;
      z-index: 1000; animation: modal-fade-in 0.2s ease-out;
    }
    .modal-content {
      background: var(--bg-color); padding: 20px; border-radius: 14px;
      width: 100%; max-width: 480px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: modal-zoom-in 0.2s ease-out;
      /* –ù–û–í–´–ô –°–¢–ò–õ–¨ */
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }
    @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-zoom-in { from { transform: scale(0.95); } to { transform: scale(1); } }
    .preview {
      white-space: pre-line; background: var(--secondary-bg-color);
      padding: 12px; border-radius: 8px; margin-top: 10px; margin-bottom: 20px;
      max-height: 45vh; overflow-y: auto; border: 1px solid var(--separator-color);
    }
    .modal-actions { display: flex; gap: 10px; }
    .modal-actions .btn-primary {
      background-color: var(--button-color);
      color: var(--button-text-color);
    }
    .modal-actions .btn-secondary {
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
    }
    .profile-btn {
      position: fixed; top: 10px; right: 16px;
      top: calc(10px + env(safe-area-inset-top));
      right: calc(16px + env(safe-area-inset-right));
      width: 40px; height: 40px; padding: 0; margin: 0; border-radius: 50%;
      font-size: 1.2em; background-color: var(--secondary-bg-color);
      color: var(--text-color); border: 1px solid var(--separator-color);
      z-index: 10; display: flex; align-items: center; justify-content: center;
    }

    /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ü–ò–°–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø --- */
    #editListContainer {
      overflow-y: auto;
      margin-top: 10px;
      margin-bottom: 10px;
      border-top: 1px solid var(--separator-color);
      border-bottom: 1px solid var(--separator-color);
      padding: 10px 0;
    }
    .edit-report-item {
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      font-weight: 500;
      text-align: left;
      padding: 14px;
      margin-top: 0;
      margin-bottom: 8px;
    }
    .edit-report-item:last-child {
      margin-bottom: 0;
    }
    #editListContainer .loading-text {
      color: var(--hint-color);
      padding: 20px;
      text-align: center;
    }
    /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function() {
      try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        if (tg.colorScheme === 'dark') {
          document.documentElement.style.colorScheme = 'dark';
        } else {
          document.documentElement.style.colorScheme = 'light';
        }
        tg.onEvent('themeChanged', function() {
          document.documentElement.style.colorScheme = tg.colorScheme;
        });
      } catch (e) { console.error('Telegram WebApp script error', e); }
    })();
  </script>
</head>
<body>
    <button type="button" id="profileBtn" class="profile-btn">üë§</button>

  <h2>–û—Ç—á—ë—Ç –æ —Å–º–µ–Ω–µ</h2>
  <h3 id="driverNameDisplay"></h3>

  <button type"button" id="loadEditsBtn" class="toggle-btn" style="margin-top: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—à–ª—É—é —Å–º–µ–Ω—É</button>

  <form id="reportForm" onsubmit="event.preventDefault(); preparePreview();">
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="date" required>
    <label>–ü—Ä–æ–µ–∫—Ç</label>
    <input id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required list="project-list" maxlength="50">
    <datalist id="project-list"></datalist>
    <label>–¢–µ—Ö–Ω–∏–∫–∞</label>
    <select id="techSelect" required></select>
    <label>–ú–µ—Å—Ç–æ / –ê–¥—Ä–µ—Å</label>
    <input id="address" placeholder="–ì–¥–µ –≤—ã —Ä–∞–±–æ—Ç–∞–ª–∏" required maxlength="100">
    <label>–°–º–µ–Ω–∞ (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
    <div class="row">
      <input type="time" id="shiftStart" required>
      <input type="time" id="shiftEnd" required>
    </div>
    <button type="button" id="addTrailerBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ü–µ–ø</button>
    <div id="trailerBlock" style="display:none;">
      <hr>
      <label>–ü—Ä–∏—Ü–µ–ø</label>
      <select id="trailerSelect"></select>
      <button type="button" id="toggleTrailerTimeBtn" class="toggle-btn" style="margin-top: 10px;">
        –í—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–º–µ–Ω—ã
      </button>
      <div id="trailerTimeInputs" style="display:none; margin-top: 10px;">
        <label>–ü—Ä–∏—Ü–µ–ø (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
        <div class="row">
          <input type="time" id="trailerStart">
          <input type="time" id="trailerEnd">
        </div>
      </div>
    </div>
    <button type="button" id="addKmBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–ø—Ä–æ–±–µ–≥</button>
    <div id="kmBlock" style="display:none;">
       <hr>
       <label>–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥ (–∫–º)</label>
       <input type="number" id="km" min="0" step="1" value="0">
    </div>
    <button type="button" id="addCommentBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    <div id="commentBlock" style="display:none;">
       <hr>
       <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
       <textarea id="comment" placeholder="–õ—é–±—ã–µ –¥–µ—Ç–∞–ª–∏, –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–º–µ—Ç–∫–∏..." rows="3" maxlength="350"></textarea>
    </div>
    <button type="submit" id="submitBtn">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é</button>
    <div id="cancelEditBtnContainer"></div>
  </form>

  <div id="modalPreview" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–µ–≤—å—é –æ—Ç—á—ë—Ç–∞</h3>
      <div id="modalPreviewText" class="preview"></div>
      <div class="modal-actions">
        <button type="button" id="editBtn" class="btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button type="button" id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
      </div>
    </div>
  </div>
  <div id="modalProfile" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è</h3>
      <label for="profileNameInput">–í–∞—à–µ –§–ò–û</label>
      <input type="text" id="profileNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
      <p style="font-size: 0.9em; color: var(--hint-color); margin-top: 8px;">
        –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –∏–º—è –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö.
      </p>
      <div class="modal-actions">
        <button type="button" id="cancelNameBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="saveNameBtn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="modalEditList" class="modal-overlay">
    <div class="modal-content">
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <div id="editListContainer">
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="modal-actions" style="margin-top: 10px;">
        <button type="button" id="cancelEditListBtn" class="btn-secondary" style="width: 100%;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>


  <script>
    // --- (1) API-–∫–ª–∏–µ–Ω—Ç (JSONP) ---
    // !! –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ API
    const API_URL = 'https://script.google.com/macros/s/AKfycbzQB13KwQTcixThKikyas74sHNAwysIiANLa46ZbpZPV05nD7Wsd7fwqMHAikH5ySQ3Jg/exec'; 

    function callApi(action, payload, callback, errorCallback) {
      const callbackName = 'jsonpCallback_' + new Date().getTime() + '_' + Math.floor(Math.random() * 100000);
      
      window[callbackName] = function(data) {
        try {
          if (data && data.status === 'error') {
            if (errorCallback) errorCallback(data); 
            else alert('–û—à–∏–±–∫–∞ API: ' + (data.message || data.error));
          } else {
            callback(data);
          }
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –≤ –∫–æ–ª–±—ç–∫–µ JSONP:", e);
          if (errorCallback) errorCallback({error: 'js_callback_error', message: e.toString()});
        }
        document.body.removeChild(script);
        delete window[callbackName];
      };

      const script = document.createElement('script');
      let src = `${API_URL}?action=${action}&callback=${callbackName}`;
      
      if (payload) {
        src += `&payload=${encodeURIComponent(JSON.stringify(payload))}`;
      }
      
      script.onerror = function() {
        const errorMsg = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
        console.error(errorMsg, src);
        if (errorCallback) errorCallback({error: 'network_error', message: errorMsg});
        else alert(errorMsg);
        
        document.body.removeChild(script);
        delete window[callbackName];
      };
      
      script.src = src;
      document.body.appendChild(script);
    }
    // --- –ö–æ–Ω–µ—Ü API-–∫–ª–∏–µ–Ω—Ç–∞ ---


    /* *** JAVASCRIPT-–õ–û–ì–ò–ö–ê *** */
    const tg = window.Telegram.WebApp;
    tg.expand(); 
    const DRAFT_KEY = 'reportDraft'; 

    let _ACCESS_METHOD = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    let _TG_ID = '';
    let _TG_USERNAME = '';
    
    // –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø: –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    let _EDIT_MODE_DATA = null; 

    // --- (–§—É–Ω–∫—Ü–∏–∏ saveDraft) ---
    function saveDraft() {
      // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫, –µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      if (_EDIT_MODE_DATA) return;
      
      const draftData = {
        date: document.getElementById('date').value, project: document.getElementById('project').value,
        tech: document.getElementById('techSelect').value, address: document.getElementById('address').value,
        shiftStart: document.getElementById('shiftStart').value, shiftEnd: document.getElementById('shiftEnd').value,
        isTrailerVisible: document.getElementById('trailerBlock').style.display === 'block',
        trailer: document.getElementById('trailerSelect').value,
        isCustomTrailerTime: document.getElementById('trailerTimeInputs').style.display === 'block',
        trailerStart: document.getElementById('trailerStart').value, trailerEnd: document.getElementById('trailerEnd').value,
        isKmVisible: document.getElementById('kmBlock').style.display === 'block',
        km: document.getElementById('km').value,
        isCommentVisible: document.getElementById('commentBlock').style.display === 'block',
        comment: document.getElementById('comment').value
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    }
    
    // --- (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è loadDraft) ---
    function loadDraft() {
      // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ - –æ—Ç–º–µ–Ω—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      cancelEdit(false); // false - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å alert

      const savedDraft = localStorage.getItem(DRAFT_KEY);
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          document.getElementById('date').value = draftData.date || new Date().toISOString().slice(0,10);
          document.getElementById('project').value = draftData.project || '';
          document.getElementById('techSelect').value = draftData.tech || '';
          document.getElementById('address').value = draftData.address || '';
          document.getElementById('shiftStart').value = draftData.shiftStart || '';
          document.getElementById('shiftEnd').value = draftData.shiftEnd || '';
          
          // –°–±—Ä–æ—Å –∏ –ø–æ–∫–∞–∑ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤
          document.getElementById('trailerBlock').style.display = 'none';
          document.getElementById('addTrailerBtn').style.display = 'block';
          document.getElementById('trailerTimeInputs').style.display = 'none';
          document.getElementById('toggleTrailerTimeBtn').style.display = 'block';
          
          if (draftData.isTrailerVisible) {
            showOptionalBlock('trailerBlock', 'addTrailerBtn');
            document.getElementById('trailerSelect').value = draftData.trailer || '';
            if (draftData.isCustomTrailerTime) {
              showOptionalBlock('trailerTimeInputs', 'toggleTrailerTimeBtn', true);
              document.getElementById('trailerStart').value = draftData.trailerStart || '';
              document.getElementById('trailerEnd').value = draftData.trailerEnd || '';
            }
          }
          
          document.getElementById('kmBlock').style.display = 'none';
          document.getElementById('addKmBtn').style.display = 'block';
          if (draftData.isKmVisible) {
            showOptionalBlock('kmBlock', 'addKmBtn');
            document.getElementById('km').value = draftData.km || '0';
          }
          
          document.getElementById('commentBlock').style.display = 'none';
          document.getElementById('addCommentBtn').style.display = 'block';
          if (draftData.isCommentVisible) {
            showOptionalBlock('commentBlock', 'addCommentBtn');
            document.getElementById('comment').value = draftData.comment || '';
          }
          
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:", e);
          localStorage.removeItem(DRAFT_KEY);
          document.getElementById('date').value = new Date().toISOString().slice(0,10);
        }
      } else {
         document.getElementById('date').value = new Date().toISOString().slice(0,10);
      }
    }
    // --- (–ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π saveDraft, loadDraft) ---


    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö)
     */
    document.addEventListener('DOMContentLoaded', () => {

      const user = tg.initDataUnsafe?.user || tg.initData?.user || null;
      _ACCESS_METHOD = user ? 'Telegram' : 'Browser (Direct Link)'; 
      _TG_ID = user ? (user.id || '') : '';
      _TG_USERNAME = user ? (user.username || '') : '';

      try {
        const openInfo = { accessMethod: _ACCESS_METHOD, tgId: _TG_ID, username: _TG_USERNAME };
        callApi('logAppOpen', openInfo, () => {}, (err) => { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è:', (err.message || err)); });
      } catch (e) { console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ª–æ–≥–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è:', e); }
      
      function handleNewUserRegistration(promptMessage) {
        let driverName = prompt(promptMessage || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û (—ç—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑):', '');
        
        if (driverName && driverName.trim()) {
          driverName = driverName.trim();
          
          try {
            const userInfo = { driverName: driverName, tgId: _TG_ID, username: _TG_USERNAME, accessMethod: _ACCESS_METHOD };
            
            callApi('notifyOfNewUser', userInfo,
              (resp) => { // –£–°–ü–ï–•
                localStorage.setItem('driverName', driverName);
                document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`;
                callApi('getReferenceLists', null, populateLists, (err) => { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: ' + (err.message || err)); });
                loadDraft(); 
                loadProjectHistory();
              },
              (err) => { // –û–®–ò–ë–ö–ê
                if (err && err.error === 'name_taken') {
                  handleNewUserRegistration(err.message || '–≠—Ç–æ –§–ò–û —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ.');
                } else {
                  console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err);
                  alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err.toString()));
                  tg.close();
                }
              }
            );
          } catch (e) { console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e); tg.close(); }
          
        } else {
          alert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è.');
          tg.close();
        }
      }

      let driverName = localStorage.getItem('driverName');
      if (!driverName) {
        handleNewUserRegistration();
      } else {
        document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`;
        callApi('getReferenceLists', null, populateLists, (err) => { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: ' + (err.message || err)); });
        loadDraft(); 
        loadProjectHistory();
      }
      
      // --- –°–ª—É—à–∞—Ç–µ–ª–∏ ---
      const fieldsToWatch = ['date', 'project', 'techSelect', 'address', 'shiftStart', 'shiftEnd', 'trailerSelect', 'trailerStart', 'trailerEnd', 'km', 'comment'];
      fieldsToWatch.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          const eventType = (element.tagName === 'SELECT') ? 'change' : 'input'; 
          element.addEventListener(eventType, saveDraft);
        }
      });
      document.getElementById('addTrailerBtn').addEventListener('click', () => { showOptionalBlock('trailerBlock', 'addTrailerBtn'); saveDraft(); });
      document.getElementById('addKmBtn').addEventListener('click', () => { showOptionalBlock('kmBlock', 'addKmBtn'); saveDraft(); });
      document.getElementById('addCommentBtn').addEventListener('click', () => { showOptionalBlock('commentBlock', 'addCommentBtn'); saveDraft(); });
      document.getElementById('toggleTrailerTimeBtn').addEventListener('click', () => { 
        showOptionalBlock('trailerTimeInputs', 'toggleTrailerTimeBtn', true);
        if (!document.getElementById('trailerStart').value) document.getElementById('trailerStart').value = document.getElementById('shiftStart').value;
        if (!document.getElementById('trailerEnd').value) document.getElementById('trailerEnd').value = document.getElementById('shiftEnd').value;
        saveDraft(); 
      });
      
      document.getElementById('editBtn').addEventListener('click', () => {
        document.getElementById('modalPreview').style.display = 'none';
        resetSendButton();
      });
      document.getElementById('sendBtn').addEventListener('click', sendReport);
      
      // –ü—Ä–æ—Ñ–∏–ª—å
      document.getElementById('profileBtn').addEventListener('click', () => {
        document.getElementById('profileNameInput').value = localStorage.getItem('driverName') || '';
        document.getElementById('modalProfile').style.display = 'flex';
      });
      document.getElementById('cancelNameBtn').addEventListener('click', () => {
        document.getElementById('modalProfile').style.display = 'none';
        resetSaveButton();
      });
      document.getElementById('saveNameBtn').addEventListener('click', handleSaveName);
      
      // –ù–û–í–´–ï –°–õ–£–®–ê–¢–ï–õ–ò –¥–ª—è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      document.getElementById('loadEditsBtn').addEventListener('click', loadLastTenReports);
      document.getElementById('cancelEditListBtn').addEventListener('click', () => {
        document.getElementById('modalEditList').style.display = 'none';
      });
    });
    
    // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è
    function showOptionalBlock(blockId, btnId, isNested = false) {
      document.getElementById(blockId).style.display = 'block';
      document.getElementById(btnId).style.display = 'none';
      if (isNested) {
          // –î–ª—è –∫–Ω–æ–ø–∫–∏ "–í—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è"
          document.getElementById(btnId).style.display = 'none';
      }
    }

    // --- (populateLists, calcOvertime –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function populateLists(data) {
      const tSel = document.getElementById('techSelect');
      const trSel = document.getElementById('trailerSelect');
      tSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É ‚Äî</option>';
      (data.tech || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; tSel.appendChild(o); });
      trSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—Ü–µ–ø ‚Äî</option>';
      (data.trailer || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; trSel.appendChild(o); });
      loadDraft();
    }
    function calcOvertime(startTime, endTime) {
      if (!startTime || !endTime) return '0:00';
      const [sh, sm] = startTime.split(':').map(Number);
      const [eh, em] = endTime.split(':').map(Number);
      let start = sh*60 + sm;
      let end = eh*60 + em;
      if (end < start) end += 24*60;
      const duration = end - start;
      const rawOvertimeMinutes = Math.max(0, duration - 12*60);
      const overtimeMinutes = Math.round(rawOvertimeMinutes / 15) * 15;
      const h = Math.floor(overtimeMinutes / 60);
      const m = overtimeMinutes % 60;
      return `${h}:${m.toString().padStart(2,'0')}`;
    }
    
    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
     * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ü–†–û–í–ï–†–Ø–ï–¢ –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
     */
    function preparePreview() {
      // (1) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—á–∏–Ω—ã
      let reason = null;
      if (_EDIT_MODE_DATA) {
        reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (max 50 —Å–∏–º–≤–æ–ª–æ–≤):", "");
        if (!reason || reason.trim() === "") {
          alert("–ü—Ä–∏—á–∏–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ç–º–µ–Ω–∞.");
          return;
        }
        reason = reason.trim().substring(0, 50);
      }
      
      // (2) –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const driverName = localStorage.getItem('driverName') || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; 
      const date = document.getElementById('date').value; 
      let formattedDate = date; 
      try { const parts = date.split('-'); formattedDate = `${parts[2]}.${parts[1]}.${parts[0].slice(-2)}`; } catch (e) { formattedDate = date; }
      const project = document.getElementById('project').value;
      const tech = document.getElementById('techSelect').value;
      const address = document.getElementById('address').value;
      const shiftStart = document.getElementById('shiftStart').value;
      const shiftEnd = document.getElementById('shiftEnd').value;
      const isTrailerVisible = document.getElementById('trailerBlock').style.display === 'block';
      const isKmVisible = document.getElementById('kmBlock').style.display === 'block';
      const isCommentVisible = document.getElementById('commentBlock').style.display === 'block';
      const comment = isCommentVisible ? document.getElementById('comment').value.trim() : '';
      const trailer = isTrailerVisible ? document.getElementById('trailerSelect').value : '';
      const km = isKmVisible ? (document.getElementById('km').value || 0) : 0;
      const customTrailerTime = document.getElementById('trailerTimeInputs').style.display === 'block';
      const trailerStart = (isTrailerVisible && customTrailerTime) ? document.getElementById('trailerStart').value : (isTrailerVisible ? shiftStart : ''); 
      const trailerEnd = (isTrailerVisible && customTrailerTime) ? document.getElementById('trailerEnd').value : (isTrailerVisible ? shiftEnd : ''); 
      
      // (3) –í–∞–ª–∏–¥–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      if (isTrailerVisible && !trailer) { alert('–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –±–ª–æ–∫ "–ü—Ä–∏—Ü–µ–ø", –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∏—Ü–µ–ø –∏–∑ —Å–ø–∏—Å–∫–∞.'); return; }
      if (isTrailerVisible && customTrailerTime && (!trailerStart || !trailerEnd)) { alert('–í—ã —É–∫–∞–∑–∞–ª–∏, —á—Ç–æ –≤—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –ø–æ–ª—è "–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü" –¥–ª—è –Ω–µ–≥–æ.'); return; }
      
      // (4) –†–∞—Å—á–µ—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const overtime = calcOvertime(shiftStart, shiftEnd);
      const trailerOvertime = (isTrailerVisible && trailer) ? calcOvertime(trailerStart, trailerEnd) : '0:00';
      
      // (5) –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–≤—å—é (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞)
      let previewItems = [
        `üóì ${formattedDate}`, `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`, `–ü—Ä–æ–µ–∫—Ç: ${project}`,
        `–¢–µ—Ö–Ω–∏–∫–∞: ${tech || '-'}`, trailer ? `–ü—Ä–∏—Ü–µ–ø: ${trailer}` : `–ü—Ä–∏—Ü–µ–ø: –Ω–µ—Ç`,
        `–ê–¥—Ä–µ—Å: ${address}`, `–°–º–µ–Ω–∞: ${shiftStart} ‚Äî ${shiftEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${overtime})`,
        trailer ? `–°–º–µ–Ω–∞ –ø—Ä–∏—Ü–µ–ø–∞: ${trailerStart} ‚Äî ${trailerEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${trailerOvertime})` : '',
        (km > 0) ? `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: ${km} –∫–º` : `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: 0 –∫–º`,
        (comment) ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}` : ''
      ];
      
      if (_EDIT_MODE_DATA) {
        previewItems.push(`\n‚ùóÔ∏è –ü–†–ò–ß–ò–ù–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø:\n${reason}`);
      }
      
      const previewText = previewItems.filter(Boolean).join('\n');
      
      // (6) –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ _REPORT
      window._REPORT = {
        date: date, driverName, tgId: _TG_ID, tgUsername: _TG_USERNAME, project, tech, 
        trailer: trailer || '–ù–µ—Ç –ø—Ä–∏—Ü–µ–ø–∞', address,
        shiftStart, shiftEnd, overtime, 
        trailerStart: trailerStart || '', trailerEnd: trailerEnd || '', trailerOvertime,
        km, comment: comment || '',
        accessMethod: _ACCESS_METHOD
      };
      
      // (7) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      if (_EDIT_MODE_DATA) {
        window._REPORT.isEdit = true;
        window._REPORT.reason = reason;
        window._REPORT.oldRowNumber = _EDIT_MODE_DATA.rowNumber;
        window._REPORT.oldMessageId = _EDIT_MODE_DATA.messageId;
      } else {
        window._REPORT.isEdit = false;
      }
      
      // (8) –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.getElementById('modalPreviewText').innerText = previewText;
      document.getElementById('modalPreview').style.display = 'flex';
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('editBtn').disabled = false;
      document.getElementById('sendBtn').innerText = _EDIT_MODE_DATA ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å (–†–µ–¥–∞–∫—Ç.)' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
    }


    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ù–û–í–´–ô –∏–ª–∏ –û–¢–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ù–´–ô –æ—Ç—á–µ—Ç
     */
    function sendReport() {
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('editBtn').disabled = true;
      document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      const successCallback = (resp) => {
        if (resp && resp.status === 'ok') {
          saveProjectHistory(window._REPORT.project);
          localStorage.removeItem(DRAFT_KEY);
          
          // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          cancelEdit(false); // false - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å alert

          tg.close(); 
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + JSON.stringify(resp));
          resetSendButton();
        }
      };
      
      const errorCallback = (err) => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + (err.message || err.toString()));
        resetSendButton();
      };
      
      // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê---
      if (window._REPORT.isEdit) {
        // –≠—Ç–æ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
        const payload = {
          oldRowNumber: window._REPORT.oldRowNumber,
          oldMessageId: window._REPORT.oldMessageId,
          reason: window._REPORT.reason,
          reportData: window._REPORT // –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –æ—Ç—á–µ—Ç–∞
        };
        callApi('submitEdit', payload, successCallback, errorCallback);
      } else {
        // –≠—Ç–æ –ù–û–í–´–ô –æ—Ç—á–µ—Ç
        callApi('submitReport', window._REPORT, successCallback, errorCallback);
      }
    }
    
    // (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
    function resetSendButton() {
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ 'preparePreview' –∏–ª–∏ 'cancelEdit'
        document.getElementById('sendBtn').innerText = _EDIT_MODE_DATA ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å (–†–µ–¥–∞–∫—Ç.)' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
    }
    
    // --- (–§—É–Ω–∫—Ü–∏–∏ –ü—Ä–æ—Ñ–∏–ª—è: handleSaveName, resetSaveButton - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function handleSaveName() {
      const oldName = localStorage.getItem('driverName') || '';
      const newName = document.getElementById('profileNameInput').value.trim();
      if (!newName) { alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!'); return; }
      if (newName === oldName) { document.getElementById('modalProfile').style.display = 'none'; return; }

      const saveBtn = document.getElementById('saveNameBtn');
      const cancelBtn = document.getElementById('cancelNameBtn');
      saveBtn.disabled = true; cancelBtn.disabled = true;
      saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      const payload = { oldName: oldName, newName: newName, accessMethod: _ACCESS_METHOD };

      const successCallback = (resp) => {
        if (resp && (resp.status === 'ok' || resp.status === 'no_change')) {
          localStorage.setItem('driverName', newName);
          document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${newName}`;
          document.getElementById('modalProfile').style.display = 'none';
          if (resp.status === 'ok') alert(`–ò–º—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!`);
        } else { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + (resp.message || resp.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')); }
        resetSaveButton();
      };

      const errorCallback = (err) => {
        if (err && err.error === 'name_taken') { alert(err.message || '–≠—Ç–æ –§–ò–û —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ.'); } 
        else { alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + (err.message || err.toString())); }
        resetSaveButton();
      };
      
      callApi('updateDriverName', payload, successCallback, errorCallback);
    }
    function resetSaveButton() {
        const saveBtn = document.getElementById('saveNameBtn');
        const cancelBtn = document.getElementById('cancelNameBtn');
        saveBtn.disabled = false; cancelBtn.disabled = false;
        saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
    
    // --- (–§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function loadProjectHistory() { /*... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...*/ }
    function saveProjectHistory(project) { /*... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...*/ }
    
    
    // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
    
    /**
     * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
     */
    function loadLastTenReports() {
      const modal = document.getElementById('modalEditList');
      const listEl = document.getElementById('editListContainer');
      listEl.innerHTML = '<div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      modal.style.display = 'flex';
      
      callApi('getLastTenReports', { tgId: _TG_ID }, showEditList, (err) => {
        listEl.innerHTML = `<div class="loading-text" style="color: var(--danger-color)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err.toString()}</div>`;
      });
    }
    
    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
     */
    function showEditList(data) {
      const reports = data.reports;
      const listEl = document.getElementById('editListContainer');
      listEl.innerHTML = '';
      
      if (!reports || reports.length === 0) {
        listEl.innerHTML = '<div class="loading-text">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>';
        return;
      }
      
      reports.forEach(report => {
        const btn = document.createElement('button');
        btn.className = 'edit-report-item';
        
        let date = report.date;
        try { const parts = report.date.split('-'); date = `${parts[2]}.${parts[1]}`; } catch (e) {}
        
        btn.innerText = `[${date}] ${report.project} (${report.tech})`;
        btn.title = `–ê–¥—Ä–µ—Å: ${report.address}\n–°–º–µ–Ω–∞: ${report.shiftStart}-${report.shiftEnd}`;
        btn.onclick = () => selectReportForEdit(report);
        listEl.appendChild(btn);
      });
    }
    
    /**
     * –í—ã–±–∏—Ä–∞–µ—Ç –æ—Ç—á–µ—Ç, –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
     */
    function selectReportForEdit(report) {
      // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      _EDIT_MODE_DATA = {
        rowNumber: report.rowNumber,
        messageId: report.messageId
      };
      
      // 2. –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('date').value = report.date;
      document.getElementById('project').value = report.project;
      document.getElementById('techSelect').value = report.tech;
      document.getElementById('address').value = report.address;
      document.getElementById('shiftStart').value = report.shiftStart;
      document.getElementById('shiftEnd').value = report.shiftEnd;

      // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ
      document.getElementById('trailerBlock').style.display = 'none';
      document.getElementById('addTrailerBtn').style.display = 'block';
      document.getElementById('trailerTimeInputs').style.display = 'none';
      document.getElementById('toggleTrailerTimeBtn').style.display = 'block';
      document.getElementById('kmBlock').style.display = 'none';
      document.getElementById('addKmBtn').style.display = 'block';
      document.getElementById('commentBlock').style.display = 'none';
      document.getElementById('addCommentBtn').style.display = 'block';

      if (report.trailer && report.trailer !== '–ù–µ—Ç –ø—Ä–∏—Ü–µ–ø–∞') {
        showOptionalBlock('trailerBlock', 'addTrailerBtn');
        document.getElementById('trailerSelect').value = report.trailer;
        
        if (report.trailerStart && (report.trailerStart !== report.shiftStart || report.trailerEnd !== report.shiftEnd)) {
          showOptionalBlock('trailerTimeInputs', 'toggleTrailerTimeBtn', true);
          document.getElementById('trailerStart').value = report.trailerStart;
          document.getElementById('trailerEnd').value = report.trailerEnd;
        }
      }
      
      if (report.km > 0) {
        showOptionalBlock('kmBlock', 'addKmBtn');
        document.getElementById('km').value = report.km;
      }
      
      if (report.comment) {
        showOptionalBlock('commentBlock', 'addCommentBtn');
        document.getElementById('comment').value = report.comment;
      }
      
      // 4. –û–±–Ω–æ–≤–ª—è–µ–º UI
      document.getElementById('modalEditList').style.display = 'none';
      document.getElementById('submitBtn').innerText = '–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)';
      
      // 5. –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
      const cancelContainer = document.getElementById('cancelEditBtnContainer');
      if (!document.getElementById('cancelEditBtn')) {
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.id = 'cancelEditBtn';
        cancelBtn.className = 'toggle-btn-danger';
        cancelBtn.innerText = '–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
        cancelBtn.onclick = cancelEdit;
        cancelContainer.appendChild(cancelBtn);
      }
      
      window.scrollTo(0, 0);
    }
    
    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫
     */
    function cancelEdit(showAlert = true) {
      if (!_EDIT_MODE_DATA && !showAlert) return; // –£–∂–µ —Å–±—Ä–æ—à–µ–Ω–æ
      
      _EDIT_MODE_DATA = null;
      document.getElementById('reportForm').reset();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
      document.getElementById('trailerBlock').style.display = 'none';
      document.getElementById('addTrailerBtn').style.display = 'block';
      document.getElementById('trailerTimeInputs').style.display = 'none';
      document.getElementById('toggleTrailerTimeBtn').style.display = 'block';
      document.getElementById('kmBlock').style.display = 'none';
      document.getElementById('addKmBtn').style.display = 'block';
      document.getElementById('commentBlock').style.display = 'none';
      document.getElementById('addCommentBtn').style.display = 'block';
      
      loadDraft(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
      
      document.getElementById('submitBtn').innerText = '–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é';
      
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (cancelBtn) cancelBtn.remove();
      
      if (showAlert) alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
    }

  </script>
</body>
</html>
