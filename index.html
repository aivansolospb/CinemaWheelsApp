<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—è</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    /* ... (–í—Å–µ –≤–∞—à–∏ CSS —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ... */
    :root {
      --bg-color: var(--tg-theme-bg-color, #ffffff);
      --text-color: var(--tg-theme-text-color, #000000);
      --button-color: var(--tg-theme-button-color, #007bff);
      --button-text-color: var(--tg-theme-button-text-color, #ffffff);
      --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --hint-color: var(--tg-theme-hint-color, #999999);
      --separator-color: var(--tg-theme-separator-color, #e0e0e0);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
      padding-bottom: calc(32px + env(safe-area-inset-bottom)); 
    }
    h2, h3 { color: var(--text-color); margin-top: 0; }
    h2 { margin-bottom: 8px; }
    #driverNameDisplay {
      color: var(--hint-color);
      font-weight: 500;
      font-size: 1.1em;
      margin-top: -5px;
      margin-bottom: 20px;
    }
    label { display: block; margin-top: 16px; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; }
    input, select, textarea {
      width: 100%; padding: 14px 12px; margin-top: 4px; border-radius: 8px;
      border: 1px solid var(--separator-color);
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      box-sizing: border-box; font-size: 1em;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: border-color 0.2s ease;
      -webkit-appearance: none;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--button-color); }
    input::placeholder, textarea::placeholder { color: var(--hint-color); }
    select {
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23${(p=>p.substring(1))(getComputedStyle(document.documentElement).getPropertyValue('--hint-color').trim() || '#999999')}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 1.2em;
      padding-right: 36px;
    }
    button {
      width: 100%; padding: 14px 12px; margin-top: 8px; border-radius: 10px;
      border: none; font-size: 1em; font-weight: 600; cursor: pointer;
      transition: opacity 0.15s ease;
    }
    button:active { opacity: 0.85; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    button[type="submit"] {
      background-color: var(--button-color);
      color: var(--button-text-color);
      margin-top: 24px;
    }
    button.toggle-btn {
      background-color: var(--secondary-bg-color);
      color: var(--button-color);
      margin-top: 15px;
      font-weight: 500;
    }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    hr { border: 0; border-top: 1px solid var(--separator-color); margin: 24px 0; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); display: none; align-items: center;
      justify-content: center; padding: 16px; box-sizing: border-box;
      z-index: 1000; animation: modal-fade-in 0.2s ease-out;
    }
    .modal-content {
      background: var(--bg-color); padding: 20px; border-radius: 14px;
      width: 100%; max-width: 480px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: modal-zoom-in 0.2s ease-out;
    }
    @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-zoom-in { from { transform: scale(0.95); } to { transform: scale(1); } }
    .preview {
      white-space: pre-line; background: var(--secondary-bg-color);
      padding: 12px; border-radius: 8px; margin-top: 10px; margin-bottom: 20px;
      max-height: 45vh; overflow-y: auto; border: 1px solid var(--separator-color);
    }
    .modal-actions { display: flex; gap: 10px; }
    .modal-actions .btn-primary {
      background-color: var(--button-color);
      color: var(--button-text-color);
    }
    .modal-actions .btn-secondary {
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
    }
    .profile-btn {
      position: fixed; top: 10px; right: 16px;
      top: calc(10px + env(safe-area-inset-top));
      right: calc(16px + env(safe-area-inset-right));
      width: 40px; height: 40px; padding: 0; margin: 0; border-radius: 50%;
      font-size: 1.2em; background-color: var(--secondary-bg-color);
      color: var(--text-color); border: 1px solid var(--separator-color);
      z-index: 10; display: flex; align-items: center; justify-content: center;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function() {
      try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        if (tg.colorScheme === 'dark') {
          document.documentElement.style.colorScheme = 'dark';
        } else {
          document.documentElement.style.colorScheme = 'light';
        }
        tg.onEvent('themeChanged', function() {
          document.documentElement.style.colorScheme = tg.colorScheme;
        });
      } catch (e) { console.error('Telegram WebApp script error', e); }
    })();
  </script>
</head>
<body>
    <button type="button" id="profileBtn" class="profile-btn">üë§</button>

  <h2>–û—Ç—á—ë—Ç –æ —Å–º–µ–Ω–µ</h2>
  <h3 id="driverNameDisplay"></h3>

  <form id="reportForm" onsubmit="event.preventDefault(); preparePreview();">
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="date" required>
    <label>–ü—Ä–æ–µ–∫—Ç</label>
    <input id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required list="project-list" maxlength="50">
    <datalist id="project-list"></datalist>
    <label>–¢–µ—Ö–Ω–∏–∫–∞</label>
    <select id="techSelect" required></select>
    <label>–ú–µ—Å—Ç–æ / –ê–¥—Ä–µ—Å</label>
    <input id="address" placeholder="–ì–¥–µ –≤—ã —Ä–∞–±–æ—Ç–∞–ª–∏" required maxlength="100">
    <label>–°–º–µ–Ω–∞ (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
    <div class="row">
      <input type="time" id="shiftStart" required>
      <input type="time" id="shiftEnd" required>
    </div>
    <button type="button" id="addTrailerBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ü–µ–ø</button>
    <div id="trailerBlock" style="display:none;">
      <hr>
      <label>–ü—Ä–∏—Ü–µ–ø</label>
      <select id="trailerSelect"></select>
      <button type="button" id="toggleTrailerTimeBtn" class="toggle-btn" style="margin-top: 10px;">
        –í—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–º–µ–Ω—ã
      </button>
      <div id="trailerTimeInputs" style="display:none; margin-top: 10px;">
        <label>–ü—Ä–∏—Ü–µ–ø (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
        <div class="row">
          <input type="time" id="trailerStart">
          <input type="time" id="trailerEnd">
        </div>
      </div>
    </div>
    <button type="button" id="addKmBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–ø—Ä–æ–±–µ–≥</button>
    <div id="kmBlock" style="display:none;">
       <hr>
       <label>–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥ (–∫–º)</label>
       <input type="number" id="km" min="0" step="1" value="0">
    </div>
    <button type="button" id="addCommentBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    <div id="commentBlock" style="display:none;">
       <hr>
       <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
       <textarea id="comment" placeholder="–õ—é–±—ã–µ –¥–µ—Ç–∞–ª–∏, –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–º–µ—Ç–∫–∏..." rows="3" maxlength="350"></textarea>
    </div>
    <button type="submit">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é</button>
  </form>

  <div id="modalPreview" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–µ–≤—å—é –æ—Ç—á—ë—Ç–∞</h3>
      <div id="modalPreviewText" class="preview"></div>
      <div class="modal-actions">
        <button type="button" id="editBtn" class="btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button type="button" id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
      </div>
    </div>
  </div>
  <div id="modalProfile" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è</h3>
      <label for="profileNameInput">–í–∞—à–µ –§–ò–û</label>
      <input type="text" id="profileNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
      <p style="font-size: 0.9em; color: var(--hint-color); margin-top: 8px;">
        –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –∏–º—è –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö.
      </p>
      <div class="modal-actions">
        <button type="button" id="cancelNameBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="saveNameBtn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>


  <script>
    // --- (1) –ù–û–í–´–ô –ë–õ–û–ö: API-–∫–ª–∏–µ–Ω—Ç (JSONP) ---
    // !! –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ API
    const API_URL = 'https://script.google.com/macros/s/AKfycbzQB13KwQTcixThKikyas74sHNAwysIiANLa46ZbpZPV05nD7Wsd7fwqMHAikH5ySQ3Jg/exec'; 

    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
     * –í—ã–∑—ã–≤–∞–µ—Ç API –Ω–∞ Apps Script —Å –ø–æ–º–æ—â—å—é JSONP
     * @param {string} action - –ö–∞–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–∑–≤–∞—Ç—å ('getReferenceLists', 'submitReport', –∏ —Ç.–¥.)
     * @param {object | null} payload - –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
     * @param {function} callback - –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
     * @param {function} [errorCallback] - (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
     */
    function callApi(action, payload, callback, errorCallback) {
      const callbackName = 'jsonpCallback_' + new Date().getTime() + '_' + Math.floor(Math.random() * 100000);
      
      window[callbackName] = function(data) {
        try {
          if (data && data.status === 'error') {
            // –ò–ó–ú–ï–ù–ï–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º –í–ï–°–¨ –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
            if (errorCallback) errorCallback(data); 
            else alert('–û—à–∏–±–∫–∞ API: ' + (data.message || data.error));
          } else {
            callback(data);
          }
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –≤ –∫–æ–ª–±—ç–∫–µ JSONP:", e);
          if (errorCallback) errorCallback({error: 'js_callback_error', message: e.toString()});
        }
        // –û—á–∏—Å—Ç–∫–∞
        document.body.removeChild(script);
        delete window[callbackName];
      };

      const script = document.createElement('script');
      let src = `${API_URL}?action=${action}&callback=${callbackName}`;
      
      if (payload) {
        src += `&payload=${encodeURIComponent(JSON.stringify(payload))}`;
      }
      
      script.onerror = function() {
        const errorMsg = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
        console.error(errorMsg, src);
        // –ò–ó–ú–ï–ù–ï–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
        if (errorCallback) errorCallback({error: 'network_error', message: errorMsg});
        else alert(errorMsg);
        
        document.body.removeChild(script);
        delete window[callbackName];
      };
      
      script.src = src;
      document.body.appendChild(script);
    }
    // --- –ö–æ–Ω–µ—Ü –ù–û–í–û–ì–û –ë–õ–û–ö–ê (1) ---


    /* *** –í–°–Ø JAVASCRIPT-–õ–û–ì–ò–ö–ê (—Å –∑–∞–º–µ–Ω–æ–π google.script.run) ***
    */
    const tg = window.Telegram.WebApp;
    tg.expand(); 
    const DRAFT_KEY = 'reportDraft'; 

    let _ACCESS_METHOD = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    let _TG_ID = '';
    let _TG_USERNAME = '';

    // --- (–§—É–Ω–∫—Ü–∏–∏ saveDraft, loadDraft –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function saveDraft() {
      const draftData = {
        date: document.getElementById('date').value, project: document.getElementById('project').value,
        tech: document.getElementById('techSelect').value, address: document.getElementById('address').value,
        shiftStart: document.getElementById('shiftStart').value, shiftEnd: document.getElementById('shiftEnd').value,
        isTrailerVisible: document.getElementById('trailerBlock').style.display === 'block',
        trailer: document.getElementById('trailerSelect').value,
        isCustomTrailerTime: document.getElementById('trailerTimeInputs').style.display === 'block',
        trailerStart: document.getElementById('trailerStart').value, trailerEnd: document.getElementById('trailerEnd').value,
        isKmVisible: document.getElementById('kmBlock').style.display === 'block',
        km: document.getElementById('km').value,
        isCommentVisible: document.getElementById('commentBlock').style.display === 'block',
        comment: document.getElementById('comment').value
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    }
    function loadDraft() {
      const savedDraft = localStorage.getItem(DRAFT_KEY);
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          document.getElementById('date').value = draftData.date || new Date().toISOString().slice(0,10);
          document.getElementById('project').value = draftData.project || '';
          document.getElementById('techSelect').value = draftData.tech || '';
          document.getElementById('address').value = draftData.address || '';
          document.getElementById('shiftStart').value = draftData.shiftStart || '';
          document.getElementById('shiftEnd').value = draftData.shiftEnd || '';
          if (draftData.isTrailerVisible) {
            document.getElementById('trailerBlock').style.display = 'block';
            document.getElementById('addTrailerBtn').style.display = 'none';
            document.getElementById('trailerSelect').value = draftData.trailer || '';
            if (draftData.isCustomTrailerTime) {
              document.getElementById('trailerTimeInputs').style.display = 'block';
              document.getElementById('toggleTrailerTimeBtn').style.display = 'none';
              document.getElementById('trailerStart').value = draftData.trailerStart || '';
              document.getElementById('trailerEnd').value = draftData.trailerEnd || '';
            }
          }
          if (draftData.isKmVisible) {
            document.getElementById('kmBlock').style.display = 'block';
            document.getElementById('addKmBtn').style.display = 'none';
            document.getElementById('km').value = draftData.km || '0';
          }
          if (draftData.isCommentVisible) {
            document.getElementById('commentBlock').style.display = 'block';
            document.getElementById('addCommentBtn').style.display = 'none';
            document.getElementById('comment').value = draftData.comment || '';
          }
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:", e);
          localStorage.removeItem(DRAFT_KEY);
          document.getElementById('date').value = new Date().toISOString().slice(0,10);
        }
      } else {
         document.getElementById('date').value = new Date().toISOString().slice(0,10);
      }
    }
    // --- (–ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π saveDraft, loadDraft) ---


    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö)
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤–µ—à–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª–∏
     */
    document.addEventListener('DOMContentLoaded', () => {

      // --- (2) –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –≤—Ö–æ–¥–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
      const user = tg.initDataUnsafe?.user || tg.initData?.user || null;
      _ACCESS_METHOD = user ? 'Telegram' : 'Browser (Direct Link)'; 
      _TG_ID = user ? (user.id || '') : '';
      _TG_USERNAME = user ? (user.username || '') : '';

      // --- (3) –ó–ê–ú–ï–ù–ê google.script.run –Ω–∞ callApi ---
      // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try {
        const openInfo = {
            accessMethod: _ACCESS_METHOD,
            tgId: _TG_ID,
            username: _TG_USERNAME
        };
        callApi('logAppOpen', openInfo, 
          () => { /* –£—Å–ø–µ—à–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º */ }, 
          (err) => { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è:', (err.message || err)); }
        );
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ª–æ–≥–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è:', e);
      }
      
      // --- (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò) ---
      
      /**
       * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
       * 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è.
       * 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
       * 3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–º—è –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.
       * 4. –ü—Ä–∏ –æ—à–∏–±–∫–µ "name_taken" - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∞–º—É —Å–µ–±—è.
       * 5. –ü—Ä–∏ –¥—Ä—É–≥–æ–π –æ—à–∏–±–∫–µ - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
       */
      function handleNewUserRegistration(promptMessage) {
        let driverName = prompt(promptMessage || '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û (—ç—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑):', '');
        
        if (driverName && driverName.trim()) {
          driverName = driverName.trim();
          
          try {
            const userInfo = {
              driverName: driverName,
              tgId: _TG_ID,
              username: _TG_USERNAME,
              accessMethod: _ACCESS_METHOD
            };
            
            // (4) –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            callApi('notifyOfNewUser', userInfo,
              (resp) => {
                // –£–°–ü–ï–•: –ò–º—è —É–Ω–∏–∫–∞–ª—å–Ω–æ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ
                localStorage.setItem('driverName', driverName);
                document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`;
                
                // (5) –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
                callApi('getReferenceLists', null, populateLists, (err) => {
                  alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: ' + (err.message || err));
                });
                
                // –ò –æ—Å—Ç–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
                loadDraft(); 
                loadProjectHistory();
              },
              (err) => {
                // –û–®–ò–ë–ö–ê:
                if (err && err.error === 'name_taken') {
                  // –ò–º—è –∑–∞–Ω—è—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
                  handleNewUserRegistration(err.message || '–≠—Ç–æ –§–ò–û —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ.');
                } else {
                  // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                  console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err);
                  alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err.toString()));
                  tg.close();
                }
              }
            );
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
            tg.close();
          }
          
        } else {
          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞" –∏–ª–∏ –≤–≤–µ–ª –ø—É—Å—Ç–æ–µ –∏–º—è
          alert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è.');
          tg.close();
        }
      }

      // --- –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
      let driverName = localStorage.getItem('driverName');
      if (!driverName) {
        // –ò–º–µ–Ω–∏ –Ω–µ—Ç -> –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        handleNewUserRegistration();
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º
        document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`;
        
        // (5) –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        callApi('getReferenceLists', null, populateLists, (err) => {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: ' + (err.message || err));
        });
        
        // –ò –æ—Å—Ç–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
        loadDraft(); 
        loadProjectHistory();
      }
      
      // --- (–û—Å—Ç–∞–ª—å–Ω–æ–π JS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
      const fieldsToWatch = ['date', 'project', 'techSelect', 'address', 'shiftStart', 'shiftEnd', 'trailerSelect', 'trailerStart', 'trailerEnd', 'km', 'comment'];
      fieldsToWatch.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          const eventType = (element.tagName === 'SELECT') ? 'change' : 'input'; 
          element.addEventListener(eventType, saveDraft);
        }
      });
      document.getElementById('addTrailerBtn').addEventListener('click', saveDraft);
      document.getElementById('addKmBtn').addEventListener('click', saveDraft);
      document.getElementById('addCommentBtn').addEventListener('click', saveDraft);
      document.getElementById('toggleTrailerTimeBtn').addEventListener('click', saveDraft);

      document.getElementById('addTrailerBtn').addEventListener('click', () => {
        document.getElementById('trailerBlock').style.display = 'block';
        document.getElementById('addTrailerBtn').style.display = 'none';
      });
      document.getElementById('addKmBtn').addEventListener('click', () => {
        document.getElementById('kmBlock').style.display = 'block';
        document.getElementById('addKmBtn').style.display = 'none';
      });
      document.getElementById('addCommentBtn').addEventListener('click', () => {
        document.getElementById('commentBlock').style.display = 'block';
        document.getElementById('addCommentBtn').style.display = 'none';
      });
      document.getElementById('toggleTrailerTimeBtn').addEventListener('click', () => {
        document.getElementById('trailerTimeInputs').style.display = 'block';
        document.getElementById('toggleTrailerTimeBtn').style.display = 'none';
        if (!document.getElementById('trailerStart').value) {
            document.getElementById('trailerStart').value = document.getElementById('shiftStart').value;
        }
        if (!document.getElementById('trailerEnd').value) {
            document.getElementById('trailerEnd').value = document.getElementById('shiftEnd').value;
        }
      });
      
      document.getElementById('editBtn').addEventListener('click', () => {
        document.getElementById('modalPreview').style.display = 'none';
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
      });
      document.getElementById('sendBtn').addEventListener('click', sendReport);
      
      document.getElementById('profileBtn').addEventListener('click', () => {
        document.getElementById('profileNameInput').value = localStorage.getItem('driverName') || '';
        document.getElementById('modalProfile').style.display = 'flex';
      });
      document.getElementById('cancelNameBtn').addEventListener('click', () => {
        document.getElementById('modalProfile').style.display = 'none';
        document.getElementById('saveNameBtn').disabled = false;
        document.getElementById('cancelNameBtn').disabled = false;
        document.getElementById('saveNameBtn').innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      });
      document.getElementById('saveNameBtn').addEventListener('click', handleSaveName);
    });

    // --- (–§—É–Ω–∫—Ü–∏–∏ populateLists, calcOvertime –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function populateLists(data) {
      const tSel = document.getElementById('techSelect');
      const trSel = document.getElementById('trailerSelect');
      tSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É ‚Äî</option>';
      (data.tech || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; tSel.appendChild(o); });
      trSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—Ü–µ–ø ‚Äî</option>';
      (data.trailer || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; trSel.appendChild(o); });
      loadDraft();
    }
    function calcOvertime(startTime, endTime) {
      if (!startTime || !endTime) return '0:00';
      const [sh, sm] = startTime.split(':').map(Number);
      const [eh, em] = endTime.split(':').map(Number);
      let start = sh*60 + sm;
      let end = eh*60 + em;
      if (end < start) end += 24*60;
      const duration = end - start;
      const rawOvertimeMinutes = Math.max(0, duration - 12*60);
      const overtimeMinutes = Math.round(rawOvertimeMinutes / 15) * 15;
      const h = Math.floor(overtimeMinutes / 60);
      const m = overtimeMinutes % 60;
      return `${h}:${m.toString().padStart(2,'0')}`;
    }
    
    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
     * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –¥–æ–±–∞–≤–ª—è–µ—Ç tgUsername
     */
    function preparePreview() {
      const driverName = localStorage.getItem('driverName') || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; 
      const date = document.getElementById('date').value; 
      let formattedDate = date; 
      try {
        const parts = date.split('-'); 
        formattedDate = `${parts[2]}.${parts[1]}.${parts[0].slice(-2)}`; 
      } catch (e) { formattedDate = date; }
      const project = document.getElementById('project').value;
      const tech = document.getElementById('techSelect').value;
      const address = document.getElementById('address').value;
      const shiftStart = document.getElementById('shiftStart').value;
      const shiftEnd = document.getElementById('shiftEnd').value;
      const isTrailerVisible = document.getElementById('trailerBlock').style.display === 'block';
      const isKmVisible = document.getElementById('kmBlock').style.display === 'block';
      const isCommentVisible = document.getElementById('commentBlock').style.display === 'block';
      const comment = isCommentVisible ? document.getElementById('comment').value.trim() : '';
      const trailer = isTrailerVisible ? document.getElementById('trailerSelect').value : '';
      const km = isKmVisible ? (document.getElementById('km').value || 0) : 0;
      const customTrailerTime = document.getElementById('trailerTimeInputs').style.display === 'block';
      const trailerStart = (isTrailerVisible && customTrailerTime) ? document.getElementById('trailerStart').value : (isTrailerVisible ? shiftStart : ''); 
      const trailerEnd = (isTrailerVisible && customTrailerTime) ? document.getElementById('trailerEnd').value : (isTrailerVisible ? shiftEnd : ''); 
      if (isTrailerVisible && !trailer) {
        alert('–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –±–ª–æ–∫ "–ü—Ä–∏—Ü–µ–ø", –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∏—Ü–µ–ø –∏–∑ —Å–ø–∏—Å–∫–∞.');
        return;
      }
      if (isTrailerVisible && customTrailerTime && (!trailerStart || !trailerEnd)) {
        alert('–í—ã —É–∫–∞–∑–∞–ª–∏, —á—Ç–æ –≤—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –ø–æ–ª—è "–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü" –¥–ª—è –Ω–µ–≥–æ.');
        return;
      }
      const overtime = calcOvertime(shiftStart, shiftEnd);
      const trailerOvertime = (isTrailerVisible && trailer) ? calcOvertime(trailerStart, trailerEnd) : '0:00';
      const previewText = [
        `üóì ${formattedDate}`, `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`, `–ü—Ä–æ–µ–∫—Ç: ${project}`,
        `–¢–µ—Ö–Ω–∏–∫–∞: ${tech || '-'}`, trailer ? `–ü—Ä–∏—Ü–µ–ø: ${trailer}` : `–ü—Ä–∏—Ü–µ–ø: –Ω–µ—Ç`,
        `–ê–¥—Ä–µ—Å: ${address}`, `–°–º–µ–Ω–∞: ${shiftStart} ‚Äî ${shiftEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${overtime})`,
        trailer ? `–°–º–µ–Ω–∞ –ø—Ä–∏—Ü–µ–ø–∞: ${trailerStart} ‚Äî ${trailerEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${trailerOvertime})` : '',
        (km > 0) ? `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: ${km} –∫–º` : `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: 0 –∫–º`,
        (comment) ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}` : ''
      ].filter(Boolean).join('\n');
      
      // –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω tgUsername
      window._REPORT = {
        date: date, driverName, 
        tgId: _TG_ID, 
        tgUsername: _TG_USERNAME, // –î–û–ë–ê–í–õ–ï–ù–û
        project, tech, 
        trailer: trailer || '–ù–µ—Ç –ø—Ä–∏—Ü–µ–ø–∞', address,
        shiftStart, shiftEnd, overtime, 
        trailerStart: trailerStart || '', trailerEnd: trailerEnd || '', trailerOvertime,
        km, comment: comment || '',
        accessMethod: _ACCESS_METHOD 
      };
      document.getElementById('modalPreviewText').innerText = previewText;
      document.getElementById('modalPreview').style.display = 'flex';
    }
    // --- (–ö–æ–Ω–µ—Ü) ---


    // --- (6) –ó–ê–ú–ï–ù–ê google.script.run –Ω–∞ callApi (–≤ sendReport) ---
    function sendReport() {
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('editBtn').disabled = true;
      document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      const successCallback = (resp) => {
        if (resp && resp.status === 'ok') {
          saveProjectHistory(window._REPORT.project);
          localStorage.removeItem(DRAFT_KEY); 
          tg.close(); 
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + JSON.stringify(resp));
          resetSendButton();
        }
      };
      
      const errorCallback = (err) => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + (err.message || err.toString()));
        resetSendButton();
      };
      
      // –í—ã–∑—ã–≤–∞–µ–º callApi
      callApi('submitReport', window._REPORT, successCallback, errorCallback);
    }
    
    function resetSendButton() {
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
    }
    
    /**
     * (–ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É –∏–º–µ–Ω–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ 'name_taken'
     */
    function handleSaveName() {
      const oldName = localStorage.getItem('driverName') || '';
      const newName = document.getElementById('profileNameInput').value.trim();
      if (!newName) {
        alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
        return;
      }
      if (newName === oldName) {
        document.getElementById('modalProfile').style.display = 'none';
        return;
      }

      const saveBtn = document.getElementById('saveNameBtn');
      const cancelBtn = document.getElementById('cancelNameBtn');
      saveBtn.disabled = true;
      cancelBtn.disabled = true;
      saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      const payload = {
        oldName: oldName,
        newName: newName,
        accessMethod: _ACCESS_METHOD 
      };

      const successCallback = (resp) => {
        if (resp && (resp.status === 'ok' || resp.status === 'no_change')) {
          localStorage.setItem('driverName', newName);
          document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${newName}`;
          document.getElementById('modalProfile').style.display = 'none';
          if (resp.status === 'ok') {
            alert(`–ò–º—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!`);
          }
        } else {
          // –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + (resp.message || resp.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        resetSaveButton();
      };

      const errorCallback = (err) => {
        // –ò–ó–ú–ï–ù–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ 'name_taken'
        if (err && err.error === 'name_taken') {
          alert(err.message || '–≠—Ç–æ –§–ò–û —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ.');
        } else {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + (err.message || err.toString()));
        }
        resetSaveButton();
      };
      
      // –í—ã–∑—ã–≤–∞–µ–º callApi
      callApi('updateDriverName', payload, successCallback, errorCallback);
    }

    function resetSaveButton() {
        const saveBtn = document.getElementById('saveNameBtn');
        const cancelBtn = document.getElementById('cancelNameBtn');
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
        saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
    
    // --- (–§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function loadProjectHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('projectHistory') || '[]');
        const datalist = document.getElementById('project-list');
        if (!document.getElementById('project').value) {
            datalist.innerHTML = ''; 
            history.forEach(project => {
              const option = document.createElement('option');
              option.value = project;
              datalist.appendChild(option);
            });
        }
      } catch (e) { console.error('Failed to load project history', e); }
    }
    function saveProjectHistory(project) {
      try {
        const currentProject = project.trim();
        if (!currentProject) return; 
        const history = JSON.parse(localStorage.getItem('projectHistory') || '[]');
        const lowerCaseProject = currentProject.toLowerCase();
        const filteredHistory = history.filter(p => p.toLowerCase() !== lowerCaseProject); 
        const newHistory = [currentProject, ...filteredHistory];
        const limitedHistory = newHistory.slice(0, 7);
        localStorage.setItem('projectHistory', JSON.stringify(limitedHistory));
      } catch (e) { console.error('Failed to save project history', e); }
    }
  </script>
</body>
</html>
