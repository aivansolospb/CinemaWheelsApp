<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á—ë—Ç –≤–æ–¥–∏—Ç–µ–ª—è</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    /* *** –ù–ê–ß–ê–õ–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–¥–∞ *** */
    :root {
      --bg-color: var(--tg-theme-bg-color, #ffffff);
      --text-color: var(--tg-theme-text-color, #000000);
      --button-color: var(--tg-theme-button-color, #007bff);
      --button-text-color: var(--tg-theme-button-text-color, #ffffff);
      --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --hint-color: var(--tg-theme-hint-color, #999999);
      /* –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã Telegram */
      --separator-color: var(--tg-theme-separator-color, #e0e0e0);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —Ç–∞–ø–µ */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      /* –ò—Å–ø–æ–ª—å–∑—É–µ–º 'safe-area-inset' –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤ –Ω–∞ iOS */
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
      /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ –∫—Ä–∞—é */
      padding-bottom: calc(32px + env(safe-area-inset-bottom)); 
    }

    h2, h3 { 
      color: var(--text-color); 
      margin-top: 0;
    }
    h2 { margin-bottom: 8px; }
    
    #driverNameDisplay {
      color: var(--hint-color);
      font-weight: 500;
      font-size: 1.1em;
      margin-top: -5px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95em;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 12px;
      margin-top: 4px;
      border-radius: 8px;
      /* –ì—Ä–∞–Ω–∏—Ü–∞ —Ü–≤–µ—Ç–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è, —Ñ–æ–Ω - –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      border: 1px solid var(--separator-color);
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      box-sizing: border-box; 
      font-size: 1em;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —Ñ–æ–∫—É—Å–∞ */
      transition: border-color 0.2s ease;
      -webkit-appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ <select> –Ω–∞ iOS */
    }

    /* –ù–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ–∫—É—Å */
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--button-color);
    }

    input::placeholder, textarea::placeholder { color: var(--hint-color); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è <select>, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª —á—É–∂–µ—Ä–æ–¥–Ω–æ */
    select {
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23${(p=>p.substring(1))(getComputedStyle(document.documentElement).getPropertyValue('--hint-color').trim() || '#999999')}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 1.2em;
      padding-right: 36px; /* –ú–µ—Å—Ç–æ –¥–ª—è —Å—Ç—Ä–µ–ª–∫–∏ */
    }

    button {
      width: 100%;
      padding: 14px 12px;
      margin-top: 8px;
      border-radius: 10px; /* –ß—É—Ç—å –±–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
      border: none;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è */
      transition: opacity 0.15s ease;
    }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
    button:active {
      opacity: 0.85;
    }
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    button[type="submit"] {
      background-color: var(--button-color);
      color: var(--button-text-color);
      margin-top: 24px;
    }

    /* –í—Ç–æ—Ä–∏—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–±—ã–≤—à–∏–π toggle-btn) */
    button.toggle-btn {
      background-color: var(--secondary-bg-color);
      color: var(--button-color); /* –¢–µ–∫—Å—Ç –≤ —Ü–≤–µ—Ç –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
      margin-top: 15px;
      font-weight: 500;
    }

    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }

    hr { 
      border: 0; 
      /* –ù–∞—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
      border-top: 1px solid var(--separator-color); 
      margin: 24px 0; 
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4); /* –ß—É—Ç—å –º—è–≥—á–µ —Ñ–æ–Ω */
      display: none; 
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
      z-index: 1000;
      /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
      animation: modal-fade-in 0.2s ease-out;
    }
    .modal-content {
      background: var(--bg-color);
      padding: 20px;
      border-radius: 14px; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω–æ–µ, –∫–∞–∫ –≤ Telegram */
      width: 100%;
      max-width: 480px;
      /* –ë–æ–ª–µ–µ –ø–ª–∞–≤–Ω–∞—è, "–Ω–∞—Ç–∏–≤–Ω–∞—è" —Ç–µ–Ω—å */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: modal-zoom-in 0.2s ease-out;
    }

    @keyframes modal-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes modal-zoom-in {
      from { transform: scale(0.95); }
      to { transform: scale(1); }
    }

    .preview {
      white-space: pre-line;
      background: var(--secondary-bg-color);
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      margin-bottom: 20px;
      max-height: 45vh;
      overflow-y: auto;
      border: 1px solid var(--separator-color);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
    }

    /* –ö–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
    .modal-actions .btn-primary {
      background-color: var(--button-color);
      color: var(--button-text-color);
    }
    .modal-actions .btn-secondary {
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
    .profile-btn {
      /* Fixed, —á—Ç–æ–±—ã –±—ã—Ç—å –Ω–∞–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å safe-area */
      position: fixed; 
      top: 10px;
      right: 16px;
      /* –û—Ç—Å—Ç—É–ø—ã –æ—Ç "—á–µ–ª–∫–∏" –∏ –∫—Ä–∞—è */
      top: calc(10px + env(safe-area-inset-top));
      right: calc(16px + env(safe-area-inset-right));
      
      width: 40px; 
      height: 40px;
      padding: 0;
      margin: 0;
      border-radius: 50%;
      font-size: 1.2em;
    S     background-color: var(--secondary-bg-color);
      color: var(--text-color);
      border: 1px solid var(--separator-color);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* *** –ö–û–ù–ï–¶: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ *** */
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function() {
      try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        // –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–º—É
        if (tg.colorScheme === 'dark') {
          document.documentElement.style.colorScheme = 'dark';
        } else {
          document.documentElement.style.colorScheme = 'light';
        }
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        tg.onEvent('themeChanged', function() {
          document.documentElement.style.colorScheme = tg.colorScheme;
        });
      } catch (e) {
        console.error('Telegram WebApp script error', e);
      }
    })();
  </script>
</head>
<body>
    <button type="button" id="profileBtn" class="profile-btn">üë§</button>

  <h2>–û—Ç—á—ë—Ç –æ —Å–º–µ–Ω–µ</h2>
  <h3 id="driverNameDisplay"></h3>

  <form id="reportForm" onsubmit="event.preventDefault(); preparePreview();">
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="date" required>

    <label>–ü—Ä–æ–µ–∫—Ç</label>
    <input id="project" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required list="project-list" maxlength="50">
    <datalist id="project-list">
    </datalist>

    <label>–¢–µ—Ö–Ω–∏–∫–∞</label>
    <select id="techSelect" required></select>

    <label>–ú–µ—Å—Ç–æ / –ê–¥—Ä–µ—Å</label>
    <input id="address" placeholder="–ì–¥–µ –≤—ã —Ä–∞–±–æ—Ç–∞–ª–∏" required maxlength="100">

    <label>–°–º–µ–Ω–∞ (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
    <div class="row">
      <input type="time" id="shiftStart" required>
      <input type="time" id="shiftEnd" required>
    </div>

    <button type="button" id="addTrailerBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ü–µ–ø</button>
    <div id="trailerBlock" style="display:none;">
      <hr>
      <label>–ü—Ä–∏—Ü–µ–ø</label>
      <select id="trailerSelect"></select>
      <button type="button" id="toggleTrailerTimeBtn" class="toggle-btn" style="margin-top: 10px;">
        –í—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–º–µ–Ω—ã
      </button>
      <div id="trailerTimeInputs" style="display:none; margin-top: 10px;">
        <label>–ü—Ä–∏—Ü–µ–ø (–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü)</label>
        <div class="row">
          <input type="time" id="trailerStart">
          <input type="time" id="trailerEnd">
        </div>
      </div>
    </div>
    <button type="button" id="addKmBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–ø—Ä–æ–±–µ–≥</button>
    <div id="kmBlock" style="display:none;">
       <hr>
       <label>–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥ (–∫–º)</label>
       <input type="number" id="km" min="0" step="1" value="0">
    </div>

    <button type="button" id="addCommentBtn" class="toggle-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    <div id="commentBlock" style="display:none;">
       <hr>
       <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
       <textarea id="comment" placeholder="–õ—é–±—ã–µ –¥–µ—Ç–∞–ª–∏, –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–º–µ—Ç–∫–∏..." rows="3" maxlength="350"></textarea>
    </div>

    <button type="submit">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é</button>
  </form>

    <div id="modalPreview" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–µ–≤—å—é –æ—Ç—á—ë—Ç–∞</h3>
      <div id="modalPreviewText" class="preview"></div>
      <div class="modal-actions">
        <button type="button" id="editBtn" class="btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button type="button" id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
      </div>
    </div>
  </div>

  <div id="modalProfile" class="modal-overlay">
    <div class="modal-content">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è</h3>
      <label for="profileNameInput">–í–∞—à–µ –§–ò–û</label>
      <input type="text" id="profileNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
      <p style="font-size: 0.9em; color: var(--hint-color); margin-top: 8px;">
        –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –∏–º—è –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö.
      </p>
      <div class="modal-actions">
        <button type="button" id="cancelNameBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="saveNameBtn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>


  <script>
    /* *** –ù–ê–ß–ê–õ–û: –ò–ó–ú–ï–ù–ï–ù–ù–´–ô JAVASCRIPT ***
    */
    
    // --- –ù–û–í–´–ô –ë–õ–û–ö: URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –∏–∑ Apps Script ---
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbx54b7wA7oE7xIZPYnXEzQeGwTmgGYCSVc2W2-HwOO0XOJJkSpe6U5D0PuU7Ng4zApfhw/exec';
    
    const tg = window.Telegram.WebApp;
    tg.expand(); 
    const DRAFT_KEY = 'reportDraft'; // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞

    // --- –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function saveDraft() {
      const draftData = {
        date: document.getElementById('date').value,
        project: document.getElementById('project').value,
        tech: document.getElementById('techSelect').value,
        address: document.getElementById('address').value,
        shiftStart: document.getElementById('shiftStart').value,
        shiftEnd: document.getElementById('shiftEnd').value,
        
        isTrailerVisible: document.getElementById('trailerBlock').style.display === 'block',
        trailer: document.getElementById('trailerSelect').value,
        isCustomTrailerTime: document.getElementById('trailerTimeInputs').style.display === 'block',
        trailerStart: document.getElementById('trailerStart').value,
        trailerEnd: document.getElementById('trailerEnd').value,
        
        isKmVisible: document.getElementById('kmBlock').style.display === 'block',
        km: document.getElementById('km').value,
        
        isCommentVisible: document.getElementById('commentBlock').style.display === 'block',
        comment: document.getElementById('comment').value
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function loadDraft() {
      const savedDraft = localStorage.getItem(DRAFT_KEY);
      if (savedDraft) {
        try {
          const draftData = JSON.parse(savedDraft);
          
          document.getElementById('date').value = draftData.date || new Date().toISOString().slice(0,10);
          document.getElementById('project').value = draftData.project || '';
          document.getElementById('techSelect').value = draftData.tech || '';
          document.getElementById('address').value = draftData.address || '';
          document.getElementById('shiftStart').value = draftData.shiftStart || '';
          document.getElementById('shiftEnd').value = draftData.shiftEnd || '';
          
          if (draftData.isTrailerVisible) {
            document.getElementById('trailerBlock').style.display = 'block';
            document.getElementById('addTrailerBtn').style.display = 'none';
            document.getElementById('trailerSelect').value = draftData.trailer || '';
            if (draftData.isCustomTrailerTime) {
              document.getElementById('trailerTimeInputs').style.display = 'block';
              document.getElementById('toggleTrailerTimeBtn').style.display = 'none';
              document.getElementById('trailerStart').value = draftData.trailerStart || '';
              document.getElementById('trailerEnd').value = draftData.trailerEnd || '';
            }
          }
          
          if (draftData.isKmVisible) {
            document.getElementById('kmBlock').style.display = 'block';
            document.getElementById('addKmBtn').style.display = 'none';
            document.getElementById('km').value = draftData.km || '0';
          }

          if (draftData.isCommentVisible) {
            document.getElementById('commentBlock').style.display = 'block';
            document.getElementById('addCommentBtn').style.display = 'none';
            document.getElementById('comment').value = draftData.comment || '';
          }
          
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:", e);
          localStorage.removeItem(DRAFT_KEY); // –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–º–∞–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
          document.getElementById('date').value = new Date().toISOString().slice(0,10);
        }
      } else {
         document.getElementById('date').value = new Date().toISOString().slice(0,10);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      
      let driverName = localStorage.getItem('driverName');
      if (!driverName) {
        driverName = prompt('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û (—ç—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑):', '');
        if (driverName && driverName.trim()) {
          driverName = driverName.trim();
          localStorage.setItem('driverName', driverName);

          // --- –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ë–õ–û–ö: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (fetch) ---
          try {
            const user = tg.initDataUnsafe?.user || tg.initData?.user || null;
            const userInfo = {
              driverName: driverName,
              tgId: user ? (user.id || '') : '',
              username: user ? (user.username || '') : ''
            };
            
            const requestData = {
              action: 'notifyOfNewUser',
              payload: userInfo
            };

            fetch(WEBAPP_URL, {
              method: 'POST',
              body: JSON.stringify(requestData),
              headers: { 'Content-Type': 'application/json' },
              redirect: 'follow'
            })
            .then(response => response.json())
            .then(resp => {
              if (resp.status !== 'ok') {
                 console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', resp.error);
              }
              // –£—Å–ø–µ—Ö - –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏–º
            })
            .catch(err => {
              console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', err); 
            });
              
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
          }
          // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

        } else {
          alert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è.');
          tg.close();
          return;
        }
      }
      document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`;

      // --- –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ë–õ–û–ö: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ (fetch) ---
      fetch(`${WEBAPP_URL}?action=getReferenceLists`)
        .then(response => response.json())
        .then(data => {
          populateLists(data);
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–∫–∏ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –ø—Ä–∏—Ü–µ–ø–æ–≤.');
        });
      // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

      loadDraft(); 
      loadProjectHistory();

      // --- –ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
      const fieldsToWatch = ['date', 'project', 'techSelect', 'address', 'shiftStart', 'shiftEnd', 'trailerSelect', 'trailerStart', 'trailerEnd', 'km', 'comment'];
      fieldsToWatch.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          const eventType = (element.tagName === 'SELECT') ? 'change' : 'input'; 
          element.addEventListener(eventType, saveDraft);
        }
      });
      document.getElementById('addTrailerBtn').addEventListener('click', saveDraft);
      document.getElementById('addKmBtn').addEventListener('click', saveDraft);
      document.getElementById('addCommentBtn').addEventListener('click', saveDraft);
      document.getElementById('toggleTrailerTimeBtn').addEventListener('click', saveDraft);

      // --- –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–Ω–æ–ø–æ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
      document.getElementById('addTrailerBtn').addEventListener('click', () => {
        document.getElementById('trailerBlock').style.display = 'block';
        document.getElementById('addTrailerBtn').style.display = 'none';
      });
      document.getElementById('addKmBtn').addEventListener('click', () => {
        document.getElementById('kmBlock').style.display = 'block';
        document.getElementById('addKmBtn').style.display = 'none';
      });
      document.getElementById('addCommentBtn').addEventListener('click', () => {
        document.getElementById('commentBlock').style.display = 'block';
        document.getElementById('addCommentBtn').style.display = 'none';
      });

      document.getElementById('toggleTrailerTimeBtn').addEventListener('click', () => {
        document.getElementById('trailerTimeInputs').style.display = 'block';
        document.getElementById('toggleTrailerTimeBtn').style.display = 'none';
        if (!document.getElementById('trailerStart').value) {
            document.getElementById('trailerStart').value = document.getElementById('shiftStart').value;
        }
        if (!document.getElementById('trailerEnd').value) {
            document.getElementById('trailerEnd').value = document.getElementById('shiftEnd').value;
        }
      });
      
      document.getElementById('editBtn').addEventListener('click', () => {
        document.getElementById('modalPreview').style.display = 'none';
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
      });
      document.getElementById('sendBtn').addEventListener('click', sendReport);
      
      document.getElementById('profileBtn').addEventListener('click', () => {
        document.getElementById('profileNameInput').value = localStorage.getItem('driverName') || '';
        document.getElementById('modalProfile').style.display = 'flex';
      });
      
      document.getElementById('cancelNameBtn').addEventListener('click', () => {
        document.getElementById('modalProfile').style.display = 'none';
        document.getElementById('saveNameBtn').disabled = false;
        document.getElementById('cancelNameBtn').disabled = false;
        document.getElementById('saveNameBtn').innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      });

      document.getElementById('saveNameBtn').addEventListener('click', handleSaveName);
 
    });

    // --- –§—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ google.script.run) ---

    function populateLists(data) {
      const tSel = document.getElementById('techSelect');
      const trSel = document.getElementById('trailerSelect');
      tSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É ‚Äî</option>';
      (data.tech || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; tSel.appendChild(o); });
      trSel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—Ü–µ–ø ‚Äî</option>';
      (data.trailer || []).forEach(x => { const o = document.createElement('option'); o.value = x; o.text = x; trSel.appendChild(o); });
      
      loadDraft();
    }

    function calcOvertime(startTime, endTime) {
      if (!startTime || !endTime) return '0:00';
      const [sh, sm] = startTime.split(':').map(Number);
      const [eh, em] = endTime.split(':').map(Number);
      let start = sh*60 + sm;
      let end = eh*60 + em;
      if (end < start) end += 24*60;
      const duration = end - start;
      const rawOvertimeMinutes = Math.max(0, duration - 12*60);
      const overtimeMinutes = Math.round(rawOvertimeMinutes / 15) * 15;
      const h = Math.floor(overtimeMinutes / 60);
      const m = overtimeMinutes % 60;
      return `${h}:${m.toString().padStart(2,'0')}`;
    }

    function preparePreview() {
      // ... (–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const user = tg.initDataUnsafe?.user || tg.initData?.user || null;
      const tgId = user ? (user.id || '') : ''; 
      const driverName = localStorage.getItem('driverName') || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; 
      const date = document.getElementById('date').value; 
      
      let formattedDate = date; 
      try {
        const parts = date.split('-'); 
        const year = parts[0].slice(-2); 
        const month = parts[1]; 
        const day = parts[2]; 
        formattedDate = `${day}.${month}.${year}`; 
      } catch (e) {
        formattedDate = date; 
      }

      const project = document.getElementById('project').value;
      const tech = document.getElementById('techSelect').value;
      const address = document.getElementById('address').value;
      const shiftStart = document.getElementById('shiftStart').value;
      const shiftEnd = document.getElementById('shiftEnd').value;
      const isTrailerVisible = document.getElementById('trailerBlock').style.display === 'block';
      const isKmVisible = document.getElementById('kmBlock').style.display === 'block';
      const isCommentVisible = document.getElementById('commentBlock').style.display === 'block';
      const comment = isCommentVisible ? document.getElementById('comment').value.trim() : '';
      const trailer = isTrailerVisible ? document.getElementById('trailerSelect').value : '';
      const km = isKmVisible ? (document.getElementById('km').value || 0) : 0;
      const customTrailerTime = document.getElementById('trailerTimeInputs').style.display === 'block';
      const trailerStart = (isTrailerVisible && customTrailerTime) 
                          ? document.getElementById('trailerStart').value 
                          : (isTrailerVisible ? shiftStart : ''); 
      const trailerEnd = (isTrailerVisible && customTrailerTime) 
                          ? document.getElementById('trailerEnd').value 
                          : (isTrailerVisible ? shiftEnd : ''); 
      if (isTrailerVisible && !trailer) {
        alert('–í—ã –¥–æ–±–∞–≤–∏–ª–∏ –±–ª–æ–∫ "–ü—Ä–∏—Ü–µ–ø", –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∏—Ü–µ–ø –∏–∑ —Å–ø–∏—Å–∫–∞.');
        return;
      }
      if (isTrailerVisible && customTrailerTime && (!trailerStart || !trailerEnd)) {
        alert('–í—ã —É–∫–∞–∑–∞–ª–∏, —á—Ç–æ –≤—Ä–µ–º—è –ø—Ä–∏—Ü–µ–ø–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –ø–æ–ª—è "–ù–∞—á–∞–ª–æ / –ö–æ–Ω–µ—Ü" –¥–ª—è –Ω–µ–≥–æ.');
        return;
      }
      const overtime = calcOvertime(shiftStart, shiftEnd);
      const trailerOvertime = (isTrailerVisible && trailer) ? calcOvertime(trailerStart, trailerEnd) : '0:00';
      
      const previewText = [
        `üóì ${formattedDate}`, 
        `–í–æ–¥–∏—Ç–µ–ª—å: ${driverName}`,
        `–ü—Ä–æ–µ–∫—Ç: ${project}`,
        `–¢–µ—Ö–Ω–∏–∫–∞: ${tech || '-'}`,
        trailer ? `–ü—Ä–∏—Ü–µ–ø: ${trailer}` : `–ü—Ä–∏—Ü–µ–ø: –Ω–µ—Ç`,
        `–ê–¥—Ä–µ—Å: ${address}`,
        `–°–º–µ–Ω–∞: ${shiftStart} ‚Äî ${shiftEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${overtime})`,
        trailer ? `–°–º–µ–Ω–∞ –ø—Ä–∏—Ü–µ–ø–∞: ${trailerStart} ‚Äî ${trailerEnd} (–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: ${trailerOvertime})` : '',
        (km > 0) ? `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: ${km} –∫–º` : `–ü–µ—Ä–µ–ø—Ä–æ–±–µ–≥: 0 –∫–º`,
        (comment) ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}` : ''
      ].filter(Boolean).join('\n');
      
      window._REPORT = {
        date: date, 
        driverName, tgId, project, tech, 
        trailer: trailer || '–ù–µ—Ç –ø—Ä–∏—Ü–µ–ø–∞', address,
        shiftStart, shiftEnd, overtime, 
        trailerStart: trailerStart || '', trailerEnd: trailerEnd || '', trailerOvertime,
        km,
        comment: comment || ''
      };
      document.getElementById('modalPreviewText').innerText = previewText;
      document.getElementById('modalPreview').style.display = 'flex';
    }

    // --- –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ë–õ–û–ö: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ (fetch) ---
    function sendReport() {
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('editBtn').disabled = true;
      document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

      const requestData = {
        action: 'submitReport',
        payload: window._REPORT
      };

      fetch(WEBAPP_URL, {
        method: 'POST',
        body: JSON.stringify(requestData),
        headers: { 'Content-Type': 'application/json' },
        redirect: 'follow'
      })
      .then(response => response.json())
      .then(resp => {
        // –õ–æ–≥–∏–∫–∞ –∏–∑ withSuccessHandler
        if (resp && resp.status === 'ok') {
          saveProjectHistory(window._REPORT.project);
          localStorage.removeItem(DRAFT_KEY); 
          tg.close(); 
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + JSON.stringify(resp));
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('editBtn').disabled = false;
          document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
        }
      })
      .catch(err => {
        // –õ–æ–≥–∏–∫–∞ –∏–∑ withFailureHandler
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + err);
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        document.getElementById('sendBtn').innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç';
      });
    }
    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

    // --- –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ë–õ–û–ö: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ (fetch) ---
    function handleSaveName() {
      const oldName = localStorage.getItem('driverName') || '';
      const newName = document.getElementById('profileNameInput').value.trim();

      if (!newName) {
        alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
        return;
      }

      if (newName === oldName) {
        document.getElementById('modalProfile').style.display = 'none';
        return;
      }

      const saveBtn = document.getElementById('saveNameBtn');
      const cancelBtn = document.getElementById('cancelNameBtn');
      saveBtn.disabled = true;
      cancelBtn.disabled = true;
      saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      const requestData = {
        action: 'updateDriverName',
        payload: { oldName: oldName, newName: newName }
      };

      fetch(WEBAPP_URL, {
        method: 'POST',
        body: JSON.stringify(requestData),
        headers: { 'Content-Type': 'application/json' },
        redirect: 'follow'
      })
      .then(response => response.json())
      .then(resp => {
        // –õ–æ–≥–∏–∫–∞ –∏–∑ withSuccessHandler
        if (resp && resp.status === 'ok') {
          localStorage.setItem('driverName', newName);
          document.getElementById('driverNameDisplay').innerText = `–í–æ–¥–∏—Ç–µ–ª—å: ${newName}`;
          document.getElementById('modalProfile').style.display = 'none';
          alert(`–ò–º—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!`);
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + (resp.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
        
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
        saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      })
      .catch(err => {
        // –õ–æ–≥–∏–∫–∞ –∏–∑ withFailureHandler
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏: ' + err);
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
        saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      });
    }
    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---
    
    // --- –§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function loadProjectHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('projectHistory') || '[]');
        const datalist = document.getElementById('project-list');
        if (!document.getElementById('project').value) {
            datalist.innerHTML = ''; 
            history.forEach(project => {
              const option = document.createElement('option');
              option.value = project;
              datalist.appendChild(option);
            });
        }
      } catch (e) { console.error('Failed to load project history', e); }
    }
    function saveProjectHistory(project) {
      try {
        const currentProject = project.trim();
        if (!currentProject) return; 
        const history = JSON.parse(localStorage.getItem('projectHistory') || '[]');
        const lowerCaseProject = currentProject.toLowerCase();
        const filteredHistory = history.filter(p => p.toLowerCase() !== lowerCaseProject); 
        const newHistory = [currentProject, ...filteredHistory];
        const limitedHistory = newHistory.slice(0, 7);
        localStorage.setItem('projectHistory', JSON.stringify(limitedHistory));
      } catch (e) { console.error('Failed to save project history', e); }
    }
  </script>
</body>
</html>
